<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Your Website</title>
  <link rel="stylesheet" type="text/css" href="css/reset.css">
  <link rel="stylesheet" type="text/css" href="css/app.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <script src="js/jquery.nicescroll.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/js/select2.min.js"></script>


</head>

<body>

  <div id="map"></div>

  <div class="box">
    <div class="box-inner">
      <div class="box-header">
        <div class="box-select">
          <h2 class="box-selectTitle">CHOOSE A MEASUREMENT</h2>
          <div class="box-input">
            <h2 class="js-box-input">All</h2>
          </div>
        </div>  
        <div class="box-select">
          <h2 class="box-selectTitle js-box-selectTitle">MALE POPULATION</h2>
          <div class="box-selectInfo">
            <h3 class="box-figure js-figure">256,982</h3>
            <p class="box-figureInfo"><span class="js-percent">45</span>% of total (<span class="js-total">545,065</span>)</p>
          </div>
        </div>
      </div>
      <div class="box-container is-hidden">
        <nav class="box-nav"></nav>
        <div class="box-result">
      </div>
    </div>
  </div>
  <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

  <script type="text/javascript">
  var sublayer;
    $( document ).ready(function() {
      var selected_column = 'total_pop'
      var selected_agg_type = 'sum'
      cartodb.createVis('map', 'https://observatory.cartodb.com/api/v2/viz/b28e2a62-1b75-11e6-bad5-0e5db1731f59/viz.json')
        .done(function(map,layers){
          sublayer = layers[1].getSubLayer(0);

          var nativeMap = map.getNativeMap()
          var table_name = 'observatory_blogpost_hero'
          var sql = new cartodb.SQL({ user: 'observatory' });
          
          var updateStats= function(){
            column_name = selected_column
            bounds = nativeMap.getBounds()
            console.log('bounds ', [bounds.getSouthWest().lng, bounds.getSouthWest().lat, bounds.getNorthEast().lng, bounds.getNorthEast().lat].join(','))
            if (selected_agg_type=='sum'){
              query = "SELECT sum({{column_name}}) AS total_value, \
                          sum( CASE WHEN the_geom && ST_MakeEnvelope({{bounds}}, 4326) THEN {{column_name}} ELSE 0 END )  AS value\
                          FROM {{table_name}} "
            }
            else if (selected_agg_type=='avg'){
              query = "with avg_total as(\
                        select avg({{column_name}}) as total from {{table_name}} \
                      )\
                      SELECT avg({{column_name}}) AS value, \
                          avg_total.total as total_value \
                          FROM {{table_name}}, avg_total \
                          where \
                        {{table_name}}.the_geom && ST_MakeEnvelope({{bounds}}, 4326) \
                        group by avg_total.total"
            }
            console.log(query)
            sql.execute(query, {  
              column_name: column_name, 
              table_name: table_name,
              agg_type: selected_agg_type,
              bounds: [bounds.getNorthEast().lng, bounds.getNorthEast().lat, bounds.getSouthWest().lng, bounds.getSouthWest().lat].join(',')
            })
              .done(function(data) {
                console.log(data)
                $(".js-figure").text(Math.floor(data.rows[0].value));
                $(".js-percent").text(Math.floor(data.rows[0].value*100.0/data.rows[0].total_value));
                $(".js-total").text(Math.floor(data.rows[0].total_value));
            })
          }
          
          nativeMap.on('move', updateStats.bind(this))

          /* read json */
          var subitemsMenu = function(e,f){
            var id = $(e).attr("data-value");
            var obj = f[id];
            var j = obj.filter_1;
            var subitems = [];
            $.each( j, function( k, val ) {
              subitems.push( "<li><a href='#' data-agg='"+val.type+"' data-col='"+val.data_col+"' data-value='" + val.value + "'>" + val.label_1 + "</a></li>" );
            });

            $( ".js-result-category" ).empty();
            $( "<ul/>", {
              "class": "box-resultList js-result-category",
              html: subitems.join( "" ),
            }).appendTo(".box-result");
          };

          var clickSubitem = function(){
            $( ".js-result-category li a" ).on( "click", function() {
              $(".js-result-category li a").removeClass( "is-selected" );
              $(this).toggleClass( "is-selected" );
              $(".js-box-selectTitle").text($(this).text());
            
              var column_name = $(this).attr('data-col')
              console.log("seeting column name ", column_name)
              sublayer.setSQL('with stats as( select max('+column_name+'), min('+column_name+') from '+table_name+')\
                                                          select ('+column_name+'-stats.min)/(stats.max-stats.min) as val from stats, ' +table_name);

              var css = sublayer.getCartoCSS();
              sublayer.setCartoCSS(css);
              
              selected_column    = $(this).attr('data-col')
              selected_agg_type  = $(this).attr('data-agg')
              updateStats();                                        
              
              
            });
          };
          var scrollFunction = function(){
            $(".js-result-category").niceScroll({
              cursorcolor: "#ccc", // change cursor color in hex
              cursorwidth: "4px"
            });
          };
          $.getJSON( "data.json", function( data ) {
            var items = [];
            $.each( data, function( key, val ) {
                if (items.length == 0) {
                  items.push( "<li><a class='is-selected' href='#'  data-value='" + key + "'>" + val.label + "</a></li>" );
                } else {
                  items.push( "<li><a href='#' data-value='" + key + "'>" + val.label + "</a></li>" );
                }     
            });
            $( "<ul/>", {
              "class": "box-navNavigation",
              html: items.join( "" )
            }).appendTo( ".box-nav" );
            subitemsMenu($( ".box-navNavigation a" ), data);
          })
            .done(function(data){
              $( ".box-navNavigation a" ).on( "click", function() {
                var txt = $(this).text();
                $(".js-box-input").text(txt);
                $(".box-navNavigation a").removeClass( "is-selected" );
                $(this).toggleClass( "is-selected" );
                subitemsMenu(this, data);
                clickSubitem();
                scrollFunction();
              });
              clickSubitem();
              scrollFunction();
            })


          $( ".box-input" ).on( "click", function() {
            $(this).toggleClass( "is-open" );
            $(".box-container").toggleClass( "is-hidden" );
          });
        })
    });

  </script>

</body>

</html>
